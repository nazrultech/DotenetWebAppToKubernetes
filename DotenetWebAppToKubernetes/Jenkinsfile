pipeline {
    agent any

    environment {
        PROJECT_NAME      = "DotnetWebAppToKubernetes"
        PACKAGE_DIR       = "/var/lib/jenkins/packages"
        BUILD_VERSION     = "v1.0.${env.BUILD_NUMBER}"
        REGISTRY_URL      = "nazrul786"  // Docker Hub username
        IMAGE_NAME        = "dotnet-k8s-webapp"
        PROJECT_PATH      = "DotenetWebAppToKubernetes/DotnetWebAppToKubernetes.csproj"
        DOCKER_CONTEXT    = "DotenetWebAppToKubernetes" // Folder with Dockerfile
    }

    stages {

        stage('Clean Workspace') {
            steps {
                echo "Cleaning workspace..."
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                echo "Fetching code from SCM..."
                checkout scm
            }
        }

        stage('Restore Dependencies') {
            steps {
                sh "dotnet restore ${PROJECT_PATH}"
            }
        }

        stage('Build App') {
            steps {
                sh "dotnet build ${PROJECT_PATH} -c Release"
            }
        }

        stage('Run Unit Tests') {
            steps {
                script {
                    if (fileExists('tests')) {
                        sh "dotnet test tests --no-build --verbosity minimal"
                    } else {
                        echo "No tests directory found — skipping unit tests."
                    }
                }
            }
        }

        stage('Publish Release Artifacts') {
            steps {
                sh "dotnet publish ${PROJECT_PATH} -c Release -o publish_output"
            }
        }

        stage('Test Docker') {
            steps {
                sh 'docker version'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                sh "docker build -t ${IMAGE_NAME}:${BUILD_VERSION} ${DOCKER_CONTEXT}/"
            }
        }

        stage('Tag & Push Docker Image') {
            steps {
                script {
                    echo "Tagging and pushing Docker image to Docker Hub..."
                    sh """
                        docker tag ${IMAGE_NAME}:${BUILD_VERSION} ${REGISTRY_URL}/${IMAGE_NAME}:${BUILD_VERSION}
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${BUILD_VERSION}
                    """
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo "Archiving publish_output/ as Jenkins artifacts"
                archiveArtifacts artifacts: 'publish_output/**/*', fingerprint: true
            }
        }

        stage('Create Deployment Package') {
            steps {
                sh """
                    mkdir -p build_package
                    cp -r publish_output/* build_package/
                    zip -r ${PROJECT_NAME}-${BUILD_VERSION}.zip build_package
                """
            }
        }

        stage('Copy Package to Folder') {
            steps {
                sh """
                    sudo mkdir -p ${PACKAGE_DIR}
                    sudo cp ${PROJECT_NAME}-${BUILD_VERSION}.zip ${PACKAGE_DIR}/
                """
            }
        }
    }

    post {
        success {
            echo "Build Successful!"
            echo "Package created: ${PROJECT_NAME}-${BUILD_VERSION}.zip"
            echo "Saved in: ${PACKAGE_DIR}"
        }
        failure {
            echo "Build Failed — check console for errors."
        }
    }
}
